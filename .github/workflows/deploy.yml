name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: |
          echo "Building with GITHUB_PAGES=true..."
          GITHUB_PAGES=true npm run build
          echo "Build completed. Verifying environment variable was used..."
          if [ -f dist/index.html ]; then
            if grep -q "/src/main.tsx" dist/index.html; then
              echo "ERROR: Build failed - HTML still contains /src/main.tsx"
              echo "This means the base path was not applied correctly."
              exit 1
            fi
          fi
        env:
          GITHUB_PAGES: 'true'

      - name: Verify build output
        run: |
          echo "Checking build output..."
          ls -la dist/
          if [ -f dist/index.html ]; then
            echo "✓ index.html exists"
            echo "--- index.html content ---"
            cat dist/index.html
            echo "--- Checking for script tags ---"
            grep -i "script" dist/index.html || echo "No script tags found"
            echo "--- Verifying script path contains base path ---"
            if grep -q "/exit38-assignment-repo/assets" dist/index.html; then
              echo "✓ Script path contains correct base path"
            else
              echo "✗ Script path is missing base path!"
              exit 1
            fi
            echo "--- Checking assets directory ---"
            ls -la dist/assets/ | head -10
          else
            echo "✗ index.html missing!"
            exit 1
          fi

      - name: Add .nojekyll file
        run: echo '' > dist/.nojekyll

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Verify dist contents before upload
        run: |
          echo "=== Final verification before upload ==="
          echo "Contents of dist/index.html:"
          cat dist/index.html
          echo ""
          echo "Checking for /src/main.tsx (should NOT exist):"
          if grep -q "/src/main.tsx" dist/index.html; then
            echo "✗ ERROR: dist/index.html still contains /src/main.tsx!"
            echo "This means the build didn't transform the HTML correctly."
            exit 1
          else
            echo "✓ No /src/main.tsx found - build is correct"
          fi
          echo ""
          echo "Checking for correct base path (should exist):"
          if grep -q "/exit38-assignment-repo/assets" dist/index.html; then
            echo "✓ Correct base path found in script tags"
          else
            echo "✗ ERROR: Base path not found in script tags!"
            exit 1
          fi

      - name: List files to be uploaded
        run: |
          echo "=== Files in dist/ that will be uploaded ==="
          find dist -type f | sort
          echo ""
          echo "=== Verifying index.html one more time ==="
          if grep -q "/src/main.tsx" dist/index.html; then
            echo "✗ CRITICAL: dist/index.html contains /src/main.tsx!"
            cat dist/index.html
            exit 1
          fi
          echo "✓ dist/index.html is correct"

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './dist'

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      
      - name: Verify deployment
        run: |
          echo "Deployment URL: ${{ steps.deployment.outputs.page_url }}"
          echo "Waiting 5 seconds for deployment to propagate..."
          sleep 5
          echo "You can now check the deployed site at: ${{ steps.deployment.outputs.page_url }}"
          echo ""
          echo "To verify the HTML is correct, view the page source and check:"
          echo "1. The script tag should point to /exit38-assignment-repo/assets/index-XXX.js"
          echo "2. It should NOT contain /src/main.tsx"